<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Konvy Log Dashboard v1.9</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --sidebar-bg: #252526;
            --text-color: #d4d4d4;
            --border-color: #333;
            --accent-color: #007acc;
            --log-info: #6a9955;
            --log-warn: #d7ba7d;
            --log-error: #f48771;
        }
        body, html { height: 100%; margin: 0; font-family: 'Consolas', 'Monaco', monospace; background: var(--bg-color); color: var(--text-color); overflow: hidden; }
        .container { display: flex; height: 100vh; }
        .sidebar { width: 320px; background: var(--sidebar-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; }
        .sidebar-header { padding: 15px; font-weight: bold; border-bottom: 1px solid var(--border-color); font-size: 14px; }
        .device-list { flex: 1; overflow-y: auto; }
        .device-group { border-bottom: 1px solid var(--border-color); }
        .device-item { padding: 12px 15px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; font-size: 13px; transition: background 0.2s; }
        .device-item:hover { background: #2a2d2e; }
        .device-item.active { background: #37373d; border-left: 4px solid var(--accent-color); }
        .chevron { width: 12px; height: 12px; transition: transform 0.3s; fill: #858585; }
        .device-group.expanded .chevron { transform: rotate(90deg); }
        .device-details { display: none; background: #1a1a1b; padding: 10px 15px; font-size: 11px; border-top: 1px solid #333; }
        .device-group.expanded .device-details { display: block; }
        .info-row { display: flex; padding: 4px 0; border-bottom: 1px solid #252526; }
        .info-key { width: 85px; color: #858585; flex-shrink: 0; }
        .info-val { color: #ce9178; word-break: break-all; flex: 1; }
        .copy-btn { color: var(--accent-color); cursor: pointer; margin-left: 5px; font-size: 10px; }
        .main { flex: 1; display: flex; flex-direction: column; }
        .toolbar { height: 45px; background: var(--sidebar-bg); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; padding: 0 15px; gap: 10px; }
        .log-container { flex: 1; overflow-y: auto; padding: 10px; font-size: 12px; line-height: 1.4; }
        .log-entry { margin-bottom: 2px; padding: 4px; border-bottom: 1px solid #2d2d2d; word-break: break-all; }
        .time { color: #858585; margin-right: 8px; font-weight: bold; }
        .tag { display: inline-block; padding: 0 4px; border-radius: 3px; font-size: 10px; margin-right: 6px; font-weight: bold; color: #fff; }
        input, select { background: #3c3c3c; border: 1px solid var(--border-color); color: white; padding: 4px 8px; border-radius: 3px; outline: none; }
        button { background: #444; color: white; border: none; padding: 5px 12px; border-radius: 3px; cursor: pointer; font-size: 11px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">设备列表 (Devices)</div>
            <div id="device-list" class="device-list">
                <div class="device-group" id="group-all">
                    <div class="device-item active" onclick="selectDevice('all')">
                        <div style="display:flex; align-items:center">
                            <div style="width:8px;height:8px;background:#4caf50;border-radius:50%;margin-right:10px"></div>
                            <span>全部设备</span>
                        </div>
                    </div>
                </div>
            </div>
            <div style="padding: 10px; display: flex; gap: 5px;">
                <button style="flex: 1;" onclick="clearLogs()">清空日志</button>
                <button style="background: #a33;" onclick="resetDevices()">重置设备</button>
            </div>
        </div>
        <div class="main">
            <div class="toolbar">
                <input type="text" id="searchInput" placeholder="搜索内容..." style="width: 180px;">
                <select id="levelFilter" onchange="refreshDisplay()">
                    <option value="all">所有级别 (All)</option>
                </select>
                <button id="sortBtn" onclick="toggleSort()">排序: 最新优先 ↓</button>
                <div style="flex:1"></div>
                <div id="status" style="font-size:10px; color:#666">Status: Disconnected</div>
            </div>
            <div id="log-container" class="log-container"><div id="log-list"></div></div>
        </div>
    </div>

    <script>
        // --- 核心配置 ---
        const SUPABASE_URL = 'https://dehcpksgjhyvoyccafnj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRlaGNwa3Nnamh5dm95Y2NhZm5qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NzU5MzAsImV4cCI6MjA4NTU1MTkzMH0.f51lBltot16OF2HmifWqUdl4sOe1SOO7f4c5k5rMAqg';

        let currentDeviceId = 'all';
        let sortDesc = true;
        let allLogs = [];
        const observedLevels = new Set();
        
        // --- 持久化逻辑：从 localStorage 恢复设备 ---
        let devices = new Map();
        try {
            const saved = localStorage.getItem('konvy_devices');
            if (saved) {
                const arr = JSON.parse(saved);
                devices = new Map(arr);
            }
        } catch (e) { console.error("Restore failed", e); }

        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY, {
            realtime: {
                params: {
                    eventsPerSecond: 10
                }
            }
        });
        
        // 强制使用 Long Polling (如果环境不支持 WebSocket 或网络不稳定)
        // 注意：目前 Supabase JS SDK 默认会自动降级，但我们可以手动配置
        const channel = _supabase.channel('konvy-logs', {
            config: { 
                broadcast: { self: false }
            }
        });

        // 初始化显示
        updateDeviceList();

        channel
            .on('broadcast', { event: 'log-event' }, ({ payload }) => {
                try {
                    // 后端现在包裹了一层 { data: ... } 以避免 422 错误
                    const parsed = payload.data || payload; 
                    if (Array.isArray(parsed)) {
                        parsed.forEach(item => processItem(item));
                    } else {
                        processItem(parsed);
                    }
                    refreshDisplay();
                } catch (e) { console.error(e); }
            })
            .subscribe((status, err) => {
                let msg = 'Status: ' + status;
                if (status === 'CHANNEL_ERROR' && err) {
                    console.error('Realtime Error:', err);
                    msg += ' (' + (err.message || JSON.stringify(err)) + ')';
                }
                document.getElementById('status').innerText = msg;
                
                if (status === 'SUBSCRIBED') {
                    console.log('Successfully connected to Supabase Realtime');
                }
            });

        function processItem(log) {
            const dId = log.deviceId || log.device_id || 'unknown';
            const dName = log.deviceName || log.device_name || 'Unknown Device';
            const level = log.level || 'info';
            
            // 如果含有 metadata 则更新并持久化
            if (!devices.has(dId) || log.metadata) {
                const existing = devices.get(dId) || {};
                devices.set(dId, { 
                    name: dName, 
                    metadata: log.metadata ? log.metadata : (existing.metadata || {}) 
                });
                saveToLocal();
                updateDeviceList();
            }

            if (!observedLevels.has(level)) {
                observedLevels.add(level);
                updateLevelFilter();
            }

            allLogs.push({
                id: dId,
                name: dName,
                level: level,
                content: log.content,
                ts: log.timestamp ? log.timestamp * 1000 : Date.now(),
                timeStr: formatTime(log.timestamp ? log.timestamp * 1000 : Date.now())
            });
            if (allLogs.length > 3000) allLogs.shift();
        }

        function saveToLocal() {
            localStorage.setItem('konvy_devices', JSON.stringify(Array.from(devices.entries())));
        }

        function formatTime(ms) {
            const d = new Date(ms);
            return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}.${String(d.getMilliseconds()).padStart(3,'0')}`;
        }

        function updateLevelFilter() {
            const filter = document.getElementById('levelFilter');
            const current = filter.value;
            filter.innerHTML = '<option value="all">所有级别 (All)</option>';
            Array.from(observedLevels).sort().forEach(level => {
                const opt = document.createElement('option');
                opt.value = level; opt.innerText = level;
                filter.appendChild(opt);
            });
            filter.value = observedLevels.has(current) ? current : 'all';
        }

        function updateDeviceList() {
            const list = document.getElementById('device-list');
            list.innerHTML = `
                <div class="device-group ${currentDeviceId === 'all' ? 'expanded' : ''}" id="group-all">
                    <div class="device-item ${currentDeviceId === 'all' ? 'active' : ''}" onclick="selectDevice('all')">
                        <div style="display:flex; align-items:center">
                            <div style="width:8px;height:8px;background:#4caf50;border-radius:50%;margin-right:10px"></div>
                            <span>全部设备</span>
                        </div>
                    </div>
                </div>
            `;
            
            devices.forEach((data, id) => {
                const meta = data.metadata || {};
                const fields = [
                    { k: 'UID', v: meta.user_id },
                    { k: 'User', v: meta.username },
                    { k: 'Version', v: meta.appVersion },
                    { k: 'OS', v: meta.osVersion },
                    { k: 'IMEI', v: meta.imei },
                    { k: 'FCM', v: meta.fcm_token },
                    { k: 'Copy', v: meta.copyText }
                ];
                
                const group = document.createElement('div');
                group.className = `device-group ${currentDeviceId === id ? 'expanded' : ''}`;
                
                let detailsHtml = '<div class="device-details">';
                fields.forEach(f => {
                    if (f.v) {
                        detailsHtml += `<div class="info-row"><div class="info-key">${f.k}:</div><div class="info-val">${f.v} <span class="copy-btn" style="color:#007acc; cursor:pointer" onclick="copyText('${f.v}', event)">[复制]</span></div></div>`;
                    }
                });
                detailsHtml += '</div>';

                group.innerHTML = `
                    <div class="device-item ${currentDeviceId === id ? 'active' : ''}" onclick="selectDevice('${id}')">
                        <div style="display:flex; align-items:center">
                            <div style="width:8px;height:8px;background:#2196f3;border-radius:50%;margin-right:10px"></div>
                            <span>${data.name}</span>
                        </div>
                        <svg class="chevron" viewBox="0 0 24 24" width="12" height="12"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6z" fill="#858585"/></svg>
                    </div>
                    ${detailsHtml}
                `;
                list.appendChild(group);
            });
        }

        function selectDevice(id) {
            if (currentDeviceId === id && id !== "all") currentDeviceId = "all";
            else currentDeviceId = id;
            updateDeviceList();
            refreshDisplay();
        }

        function copyText(text, event) {
            event.stopPropagation();
            navigator.clipboard.writeText(text).then(() => alert('已复制'));
        }

        function refreshDisplay() {
            const list = document.getElementById('log-list');
            list.innerHTML = '';
            const term = document.getElementById('searchInput').value.toLowerCase();
            const selectedLevel = document.getElementById('levelFilter').value;

            let displayLogs = allLogs.filter(l => {
                const matchDevice = (currentDeviceId === 'all' || l.id === currentDeviceId);
                const matchLevel = (selectedLevel === 'all' || l.level === selectedLevel);
                const contentStr = (JSON.stringify(l.content) || "").toLowerCase();
                const matchSearch = !term || contentStr.includes(term);
                return matchDevice && matchLevel && matchSearch;
            });

            displayLogs.sort((a, b) => sortDesc ? b.ts - a.ts : a.ts - b.ts);
            displayLogs.forEach(log => {
                const div = document.createElement('div');
                div.className = 'log-entry';
                const colors = { error: '#f48771', warn: '#d7ba7d', info: '#6a9955', debug: '#b5cea8' };
                const levelColor = colors[log.level.toLowerCase()] || colors.info;
                div.innerHTML = `<span class="time">${log.timeStr}</span><span class="tag" style="background:${levelColor}">${log.level}</span><span style="color:#569cd6">[${log.name}]</span> <span style="color:#ce9178">${JSON.stringify(log.content, null, 2)}</span>`;
                list.appendChild(div);
            });
        }

        function toggleSort() {
            sortDesc = !sortDesc;
            document.getElementById('sortBtn').innerText = sortDesc ? "排序: 最新优先 ↓" : "排序: 最旧优先 ↑";
            refreshDisplay();
        }

        function clearLogs() { allLogs = []; refreshDisplay(); }
        
        function resetDevices() {
            if (confirm("确定要清空所有已保存的设备信息吗？")) {
                localStorage.removeItem('konvy_devices');
                devices = new Map();
                updateDeviceList();
            }
        }

        document.getElementById('searchInput').oninput = () => refreshDisplay();
    </script>
</body>
</html>
